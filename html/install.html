
<html>
<head>
<style>
    h3 {
        color: #2C3E50;
    }
    body {
        max-width: 800px;
        margin: 1em auto;
        font-size: 1.2em;
    }
    pre {
        background-color: #f3f3f3;
        padding: 1em;
    }
    code {
        background-color: #f3f3f3;
        padding: 0.2em;
    }
    .warning {
        color: #900;
        font-weight: bold;
    }
    .param {
        background-color: #D6EAF8;
        font-weight: bold;
        padding: 0.2em;
    }
    .param-mention {
        font-weight: bold;
    }
    .label {
        background-color: #E5E8E8;
        padding: 0.2em;
    }
    .when-label {
        margin-bottom: 1em;
    }
    .indent-1 {
        padding-left: 2em;
        border-left: 5px solid #f3f3f3;
    }
</style>
</head>
<body>

<h3>Parameters</h3>
<div>setup_user = <span data-name="setup_user" class="param">user</span></div>
<div>setup_ssh_authorized_key = <span data-name="setup_ssh_authorized_key" class="param">https://github.com/lorien.keys</span></div>
<div class="indent-0">
<h3>Setup font for console environment</h3>
<pre>For high-resolution screens use bigger font
Run dpkg-reconfigure -plow console-setup
    Encoding: UTF-8
    Character set: combined -- Latin; Slavic Cyrillic; Hebrew; basic Arabian
    Font: VGA
    Size: 16x32
</pre>
<h3>Setup HTTPS support for APT repositories</h3>
Run command <code>apt install apt-transport-https curl</code>
<h3>Install bluetooth drivers</h3>
Run command <code>apt install firmware-iwlwifi</code>
<h3>Setup service for /etc/rc.local</h3>
<div class="indent-1">
<h3>Enable systemd rc-local service</h3>
Run command: <code>systemctl enable rc-local</code>
<h3>Create minimal /etc/rc.local file if it does not exists</h3>
Write to file /etc/rc.local (do not overwrite if file exists) this content:<pre>#!/bin/bash
exit 0
</pre>
</div><!-- end of div.indent-* -->
<h3>Install rfkill</h3>
Run command <code>apt install rfkill</code>
<h3>Disable bluetooth</h3>
<div class="indent-1">
<h3>Stop bluetooth systemd service</h3>
Run command: <pre>systemctl stop bluetooth \
    && systemctl disable bluetooth</pre>
<h3>Setup disabling wifi on hardware level in /etc/rc.local</h3>
To file <code>/etc/rc.local</code> add line <code>rfkill block bluetooth</code>
</div><!-- end of div.indent-* -->
<h3>Set up DNS</h3>
<div class="indent-1">
<h3>Configure public name services in /etc/resolv.conf</h3>
Write to file /etc/resolv.conf (do not overwrite if file exists) this content:<pre>nameserver server=8.8.8.8 # google
nameserver server=77.88.8.8 # yandex
</pre>
<h3>Restrict modification of /etc/resolv.conf file</h3>
Run command: <pre>chattr +i /etc/resolv.conf</pre>
</div><!-- end of div.indent-* -->
<h3>Setup standard repositories in /etc/apt/sources.list</h3>
<div class="indent-1">
<h3>Use HTTPS for all repositories</h3>
In file /etc/apt/sources.list replace all lines that match regexp ^deb http://(.+) with deb https://\1
<h3>Use "main contrib non-free non-free-firmware" for all standard repositories</h3>
In file /etc/apt/sources.list replace all lines that match regexp ^(.+/(?:debian|debian-security).*bookworm).*main.* with \1 main contrib non-free non-free-firmware
<h3>Update APT cache</h3>
Update APT cache.
</div><!-- end of div.indent-* -->
<h3>Install SSH Server and disable it</h3>
<div class="indent-1">
<h3>Install ssh server</h3>
Run command <code>apt install openssh-server</code>
<h3>Disable and stop ssh server</h3>
Run command: <pre>systemctl stop ssh \
    && systemctl disable ssh</pre>
</div><!-- end of div.indent-* -->
<h3>Config Files</h3>
<pre>TODO
Base content of files must be part of this document.
Copy files from backup to user's home directory:
- .xsession
- .vimrc
- .config/awesome/rc.lua
- .bashrc.personal
- .tmux.conf
- .gitconfig
- .hgrc
- .pypirc (HAS TOKEN)
- .Xresources
- .xbindkeysrc
- ~/bin/
Add `source ~/.bashrc.personal` to "~/.bashrc"
</pre>
<h3>Install sudo package and add user to sudo group</h3>
<div class="indent-1">
<h3>Install sudo package</h3>
Run command <code>apt install sudo</code>
<h3>Add user to sudo group</h3>
Add user <span data-name="setup_user" class="param">user</span> to groups sudo
</div><!-- end of div.indent-* -->
<h3>Setup vim editor</h3>
<div class="indent-1">
<h3>apt</h3>
Run command <code>apt install python3-venv git vim-nox</code>
<h3>debug</h3>
<pre>TODO
Also copy .vimrc to /root/.vimrc
sudo pip3 install black
Run vim, then inside thim run ":PlugInstall"
Run: update-alternatives --config editor # choose vim-nox
Run: select-editor # for current user, choose vim-nox
Run: sudo select-editor # for root, choose vim-nox
</pre>
</div><!-- end of div.indent-* -->
<h3>Copy ~/doc</h3>
<pre>Copy docs
Symlink ~/doc/.ssh ~/.ssh
</pre>
<h3>System backup</h3>
<pre>/etc/hosts
</pre>
<h3>Install packages to run desktop environment</h3>
Run command <code>apt install xorg xserver-xorg-input-synaptics xserver-xorg-input-all awesome slim dbus-x11 vim-gui-common xbindkeys rxvt-unicode xss-lock flameshot slock brightnessctl</code>
<h3>Make urxvt default terminal emulator</h3>
Run shell command: update-alternatives --set x-terminal-emulator /usr/bin/urxvt
<h3>Configure terminal emulator font</h3>
<div class="indent-1">
<h3>Install ttf-bitstream-vera font</h3>
Run command <code>apt install ttf-bitstream-vera</code>
<h3>debug</h3>
<pre>Possibly update "size=XX" in the line "URxvt ... font: xft:...size=XX"
xrdb ~/.Xresources
</pre>
</div><!-- end of div.indent-* -->
<h3>Install Network Manager and configure it</h3>
<div class="indent-1">
<h3>Install Network Manager and utilities</h3>
Run command <code>apt install network-manager network-manager-gnome network-manager-openvpn</code>
<h3>debug</h3>
<pre>ifdown <wifi-iface>
Comment out lines in /etc/network/interfaces for wifi adapter
systemctl restart networking
Write to /etc/NetworkManager/conf.d/00-random-mac.conf:
    [device]
    wifi.scan-rand-mac-address=yes
    [connection]
    wifi.cloned-mac-address=stable
    ethernet.cloned-mac-address=stable
</pre>
</div><!-- end of div.indent-* -->
<h3>Update ~/.Xresources</h3>
<pre>Use https://dpi.lv/ to calculate DPI
Update "Xft.dpi: ..." line
xrdb ~/.Xresources
</pre>
<h3>Start GUI</h3>
<pre>systemctl start slim
if network manager says "device not ready" for wifi card, then restart laptop
might be caused by old network settings in /etc/network/interfaces
</pre>
<h3>Intel sof (WTF?)</h3>
<pre>download tarball from https://github.com/thesofproject/sof-bin/releases
unpack
sudo mv /lib/firmware/intel/sof* some_backup_location/
sudo mv /usr/local/bin/sof-*     some_backup_location/ # optional
rsync -a sof-v1.7/       /lib/firmware/intel/sof/
rsync -a sof-tplg-v1.7/  /lib/firmware/intel/sof-tplg/
rsync tools-v1.7/        /usr/local/bin/
</pre>
<h3>Install brave browser</h3>
<div class="indent-1">
<h3>Download brave browser repo signature</h3>
Download document at https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg and save it to /usr/share/keyrings/brave-browser-archive-keyring.gpg , do nothing if file exists already
<h3>Configure APT repository for brave browser</h3>
Write to file /etc/apt/sources.list.d/brave-browser-release.list (do not overwrite if file exists) this content:<pre>deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main
</pre>
<h3>Install brave browser package</h3>
Update APT cache.
</div><!-- end of div.indent-* -->
<h3>As alternative to Brave Browser install Libre Wolf</h3>
<pre>See ~/bin/install_librewolf.sh
</pre>
<h3>Powertop</h3>
<pre>sudo powertop --auto-tune # WTF how it works?
</pre>
<h3>Sound</h3>
<div class="indent-1">
<h3>Install sound servers and utilities</h3>
Run command <code>apt install pulseaudio pavucontrol alsa-utils</code>
<h3>debug</h3>
<pre>Restart laptop
Run pavucontrol, go Output Devices tab. Ensure that output is not muted.
</pre>
</div><!-- end of div.indent-* -->
<h3>Install and configure development tools</h3>
<div class="indent-1">
<h3>Install development packages</h3>
Run command <code>apt install mariadb-client git mercurial p7zip-full unrar xz-utils libcurl4-openssl-dev libssl-dev build-essential strace screen tmux iotop python-is-python3 python3-venv dnsutils whois traceroute pkg-config python3-pip psmisc rsync</code>
<h3>debug</h3>
<pre>pip3 install --break-system-packages -U pip
pip3 install --break-system-packages -U \
    cookiecutter virtualenv pytest tox twine \
    autosort black isort
</pre>
</div><!-- end of div.indent-* -->
<h3>Proxychains</h3>
<pre>pip install -U mazer
pip install -U ansible
mazer install --namespace lorien git+https://github.com/lorien/cluster
# or
# cd /web
# git clone https://github.com/lorien/cluster
# mazer install -namespace lorien -e /web/cluster
anz.py role lorien.cluster.proxychains local
</pre>
<h3>Setup using shared beeline internet</h3>
<div class="indent-1">
<h3>Set sysctl net.ipv4.ip_default_ttl</h3>
Add setting <code>net.ipv4.ip_default_ttl</code> = <code>65</code> to <code>/etc/sysctl.conf</code> and run <code>sysctl -p</code>
</div><!-- end of div.indent-* -->
<h3>Install smartmontools</h3>
Run command <code>apt install smartmontools</code>
<h3>Disable IPv6, optional</h3>
<div class="indent-1">
<h3>Set sysctl net.ipv6.conf.all.disable_ipv6</h3>
Add setting <code>net.ipv6.conf.all.disable_ipv6</code> = <code>1</code> to <code>/etc/sysctl.conf</code> and run <code>sysctl -p</code>
<h3>Set sysctl net.ipv6.conf.default.disable_ipv6</h3>
Add setting <code>net.ipv6.conf.default.disable_ipv6</code> = <code>1</code> to <code>/etc/sysctl.conf</code> and run <code>sysctl -p</code>
<h3>debug</h3>
<pre>Update /etc/default/grub:
    GRUB_CMDLINE_LINUX_DEFAULT="ipv6.disable=1  quiet"
Run:
    update-grub
    update-grub2
Reboot
</pre>
</div><!-- end of div.indent-* -->
<h3>Install tools for power management on laptop</h3>
Run command <code>apt install tlp</code>
<h3>Install tools to configure display brightness</h3>
<div class="indent-1">
<h3>Install brightnessctl package</h3>
Run command <code>apt install brightnessctl</code>
<h3>debug</h3>
<pre>sudo chown root:user /sys/devices/pci0000\:00/0000\:00\:02.0/drm/card0/card0-eDP-1/intel_backlight/brightness
sudo chmod g+rw /sys/devices/pci0000\:00/0000\:00\:02.0/drm/card0/card0-eDP-1/intel_backlight/brightness
Update ~/.xbindkeysrc
    "brightnessctl s 10%-"
      XF86MonBrightnessDown
    "brightnessctl s +10%"
      XF86MonBrightnessUp
</pre>
</div><!-- end of div.indent-* -->
<h3>On desktop, disable wifi power save</h3>
<pre>That helps to remove lags if you connect the desktop via ssh
from other machine
Put into /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf:
    [connection]
    wifi.powersave = 2 # 2 means disable
</pre>
<h3>Setup SSH daemon</h3>
<div class="indent-1">
<h3>Configure SSH authorized key to access root account</h3>
Add key located at <span data-name="setup_ssh_authorized_key" class="param">https://github.com/lorien.keys</span> to SSH authorized keys of user root
<h3>Configure SSH server do not use password authentication</h3>
<div class="indent-2">
<h3>lineinfile</h3>
To file <code>/etc/ssh/sshd_config</code> add line <code>PasswordAuthentication no</code>
<h3>lineinfile</h3>
To file <code>/etc/ssh/sshd_config</code> add line <code>ChallengeResponseAuthentication no</code>
</div><!-- end of div.indent-* -->
<h3>Restart SSH server</h3>
Run command: <code>systemctl restart ssh</code>
</div><!-- end of div.indent-* -->
<h3>TRIM Operation for SSD</h3>
<pre>There is nothing to do. Systemd service "fstrim" is active by default.
</pre>
<h3>Low swap priority</h3>
<div class="indent-1">
<h3>Set sysctl vm.swappiness</h3>
Add setting <code>vm.swappiness</code> = <code>1</code> to <code>/etc/sysctl.conf</code> and run <code>sysctl -p</code>
</div><!-- end of div.indent-* -->
<h3>Screenshots</h3>
Run command <code>apt install flameshot</code>
<h3>For IDEA</h3>
<div class="indent-1">
<h3>Set sysctl fs.inotify.max_user_watches</h3>
Add setting <code>fs.inotify.max_user_watches</code> = <code>524288</code> to <code>/etc/sysctl.conf</code> and run <code>sysctl -p</code>
</div><!-- end of div.indent-* -->
<h3>Setup download directory</h3>
<div class="indent-1">
<h3>Create ~/Downloads directory</h3>
Run command: <pre>mkdir -p /home/<span data-name="setup_user" class="param">user</span>/Downloads \
    && chown <span data-name="setup_user" class="param">user</span> /home/<span data-name="setup_user" class="param">user</span>/Downloads \
    && chown :<span data-name="setup_user" class="param">user</span> /home/<span data-name="setup_user" class="param">user</span>/Downloads</pre>
<h3>Create symlink ~/down -> ~/Downloads</h3>
Run command: <pre>ln -s /home/<span data-name="setup_user" class="param">user</span>/Downloads /home/<span data-name="setup_user" class="param">user</span>/down \
    && chown <span data-name="setup_user" class="param">user</span> /home/<span data-name="setup_user" class="param">user</span>/down \
    && chown :<span data-name="setup_user" class="param">user</span> /home/<span data-name="setup_user" class="param">user</span>/down</pre>
</div><!-- end of div.indent-* -->
</div><!-- end of div.indent-* -->
</body>
